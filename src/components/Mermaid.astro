---
export interface Props {
  id?: string;
  diagram: string;
  class?: string;
}

const { id = `mermaid-${Math.random().toString(36).substring(2, 15)}`, diagram, class: className = '' } = Astro.props;
---

<div id={id} class={`mermaid-container ${className}`}>
  <pre class="mermaid">{diagram}</pre>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const mermaid = await import('mermaid');
      
      // Initialize mermaid
      mermaid.default.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        fontFamily: 'Inter, system-ui, sans-serif',
        flowchart: {
          htmlLabels: true,
          curve: 'basis'
        }
      });

      // Render all mermaid diagrams
      const mermaidElements = document.querySelectorAll('.mermaid');
      for (let i = 0; i < mermaidElements.length; i++) {
        const element = mermaidElements[i];
        const diagram = element.textContent;
        
        if (diagram) {
          try {
            const { svg } = await mermaid.default.render(`mermaid-${i}-${Date.now()}`, diagram);
            element.innerHTML = svg;
          } catch (error) {
            console.error('Mermaid rendering error:', error);
            element.innerHTML = `<div class="text-red-500 p-4 border border-red-300 rounded bg-red-50">Error rendering diagram</div>`;
          }
        }
      }
    } catch (error) {
      console.error('Failed to load mermaid:', error);
    }
  });
</script>

<style>
  .mermaid-container {
    margin: 2rem 0;
    text-align: center;
  }

  .mermaid {
    background: transparent;
    border: none;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
  }

  .mermaid svg {
    max-width: 100%;
    height: auto;
    font-family: Inter, system-ui, sans-serif;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .mermaid-container {
      margin: 1rem 0;
    }
    
    .mermaid svg {
      font-size: 12px;
    }
  }
</style>